-- tr_image Table Create SQL
CREATE TABLE tr_image
(
    `no`                 BIGINT          NOT NULL    AUTO_INCREMENT COMMENT 'AI Index',
    `image_name`         VARCHAR(255)    NOT NULL    COMMENT '이미지 이름',
    `image_path`         CHAR(15)        NOT NULL    COMMENT '이미지 경로',
    `status`             CHAR(5)         NOT NULL    DEFAULT 'ALIVE' COMMENT '활성화(ALIVE), 삭제(DEAD)',
    `registration_date`  TIMESTAMP       NOT NULL    DEFAULT current_timestamp COMMENT '등록일',
    `updated`            TIMESTAMP       NOT NULL    DEFAULT current_timestamp COMMENT '업데이트 일자',
     PRIMARY KEY (no)
);

ALTER TABLE tr_image COMMENT '이미지 테이블';

CREATE INDEX IX_tr_image_1
    ON tr_image(image_name, image_path);

CREATE UNIQUE INDEX UQ_tr_image_1
    ON tr_image(image_name);


-- tr_account Table Create SQL
CREATE TABLE tr_account
(
    `no`            BIGINT          NOT NULL    AUTO_INCREMENT COMMENT 'AI Index',
    `id`            VARCHAR(20)     NOT NULL    COMMENT '아이디',
    `password`      VARCHAR(255)    NOT NULL    COMMENT '패스워드',
    `name`          VARCHAR(10)     NOT NULL    COMMENT '이름',
    `email`         VARCHAR(45)     NOT NULL    COMMENT '이메일',
    `email_status`  CHAR(8)         NOT NULL    DEFAULT 'INACTIVE' COMMENT '인증 미 완료(INACTIVE),  인증 완료(ACTIVE)',
    `status`        CHAR(5)         NOT NULL    DEFAULT 'ALIVE' COMMENT '일반 회원(ALIVE), 탈퇴 신청 회원(AWAIT), 탈퇴 회원(DEAD)',
    `registered`    TIMESTAMP       NOT NULL    DEFAULT current_timestamp COMMENT '가입 일자',
    `updated`       TIMESTAMP       NOT NULL    DEFAULT current_timestamp COMMENT '업데이트 날자',
     PRIMARY KEY (no)
);

ALTER TABLE tr_account COMMENT '회원 테이블';

CREATE INDEX IX_tr_account_1
    ON tr_account(id);

CREATE UNIQUE INDEX UQ_tr_account_2
    ON tr_account(email);

CREATE UNIQUE INDEX UQ_tr_account_1
    ON tr_account(id);


-- tr_product Table Create SQL
CREATE TABLE tr_product
(
    `no`                 BIGINT          NOT NULL    AUTO_INCREMENT COMMENT 'AI Index',
    `user_no`            BIGINT          NOT NULL    COMMENT '등록한 유저 PK',
    `image_no`           BIGINT          NOT NULL    COMMENT '이미지 테이블 PK',
    `name`               VARCHAR(20)     NOT NULL    COMMENT '상품명',
    `information`        VARCHAR(100)    NOT NULL    COMMENT '상품 설명',
    `before_price`       INT UNSIGNED    NOT NULL    COMMENT '상품 가격',
    `commission`         INT UNSIGNED    NOT NULL    DEFAULT 0 COMMENT '수수료',
    `after_price`        INT UNSIGNED    NOT NULL    COMMENT '수수료 적용 가격',
    `registration_date`  TIMESTAMP       NOT NULL    DEFAULT current_timestamp COMMENT '등록일',
    `updated`            TIMESTAMP       NOT NULL    DEFAULT current_timestamp COMMENT '업데이트 일자',
     PRIMARY KEY (no)
);

ALTER TABLE tr_product COMMENT '상품 테이블';

CREATE INDEX IX_tr_product_1
    ON tr_product(user_no);

ALTER TABLE tr_product
    ADD CONSTRAINT FK_tr_product_user_no_tr_account_no FOREIGN KEY (user_no)
        REFERENCES tr_account (no) ON DELETE RESTRICT ON UPDATE RESTRICT;

ALTER TABLE tr_product
    ADD CONSTRAINT FK_tr_product_image_no_tr_image_no FOREIGN KEY (image_no)
        REFERENCES tr_image (no) ON DELETE RESTRICT ON UPDATE RESTRICT;


-- tr_board Table Create SQL
CREATE TABLE tr_board
(
    `no`                 BIGINT          NOT NULL    AUTO_INCREMENT COMMENT 'AI Index',
    `user_no`            BIGINT          NOT NULL    COMMENT '등록한 유저 PK',
    `image_no`           BIGINT          NOT NULL    COMMENT '이미지 테이블 PK',
    `title`              VARCHAR(20)     NOT NULL    COMMENT '게시글 제목',
    `content`            VARCHAR(100)    NOT NULL    COMMENT '게시글 내용',
    `board_type`         CHAR(10)        NOT NULL    COMMENT '게시물 타입(default:일반, trad:거래, event:이벤트, note:공지 등등)',
    `reference_no`       BIGINT          NULL        COMMENT '참조 테이블 PK',
    `status`             CHAR(5)         NOT NULL    COMMENT '활성화(ALIVE), 임시 저장(AWAIT), 삭제(DEAD)',
    `registration_date`  TIMESTAMP       NOT NULL    DEFAULT current_timestamp COMMENT '등록일',
    `updated`            TIMESTAMP       NOT NULL    DEFAULT current_timestamp COMMENT '업데이트 일자',
     PRIMARY KEY (no)
);

ALTER TABLE tr_board COMMENT '게시물 테이블';

CREATE INDEX IX_tr_board_2
    ON tr_board(board_type, status);

CREATE INDEX IX_tr_board_1
    ON tr_board(user_no, board_type, status);

ALTER TABLE tr_board
    ADD CONSTRAINT FK_tr_board_user_no_tr_account_no FOREIGN KEY (user_no)
        REFERENCES tr_account (no) ON DELETE RESTRICT ON UPDATE RESTRICT;

ALTER TABLE tr_board
    ADD CONSTRAINT FK_tr_board_image_no_tr_image_no FOREIGN KEY (image_no)
        REFERENCES tr_image (no) ON DELETE RESTRICT ON UPDATE RESTRICT;


-- tr_mileage Table Create SQL
CREATE TABLE tr_mileage
(
    `no`                 BIGINT          NOT NULL    AUTO_INCREMENT COMMENT 'AI Index',
    `user_no`            BIGINT          NOT NULL    COMMENT '유저 PK',
    `using_mileage`      INT UNSIGNED    NOT NULL    DEFAULT 0 COMMENT '사용중 마일리지',
    `use_mileage`        INT UNSIGNED    NOT NULL    DEFAULT 0 COMMENT '사용 가능 마일리지(이벤트성 마일리지) : 출금 불가능',
    `real_mileage`       INT UNSIGNED    NOT NULL    DEFAULT 0 COMMENT '출금 가능 마일리지(충전&거래 한 마일리지)',
    `registration_date`  TIMESTAMP       NOT NULL    DEFAULT current_timestamp COMMENT '생성 날짜',
    `updated`            TIMESTAMP       NOT NULL    DEFAULT current_timestamp COMMENT '업데이트 날짜',
     PRIMARY KEY (no)
);

ALTER TABLE tr_mileage COMMENT '유저 마일리지 테이블';

CREATE INDEX IX_tr_mileage_1
    ON tr_mileage(user_no);

CREATE UNIQUE INDEX UQ_tr_mileage_1
    ON tr_mileage(user_no);

ALTER TABLE tr_mileage
    ADD CONSTRAINT FK_tr_mileage_user_no_tr_account_no FOREIGN KEY (user_no)
        REFERENCES tr_account (no) ON DELETE RESTRICT ON UPDATE RESTRICT;


-- tr_withdrawal_log Table Create SQL
CREATE TABLE tr_withdrawal_log
(
    `no`                   BIGINT          NOT NULL    AUTO_INCREMENT COMMENT 'AI Index',
    `user_no`              BIGINT          NOT NULL    COMMENT '유저 PK',
    `withdrawal_mileage`   INT UNSIGNED    NOT NULL    COMMENT '출금 마일리지',
    `bank_name`            VARCHAR(10)     NOT NULL    COMMENT '은행 이름',
    `bank_account_number`  VARCHAR(255)    NOT NULL    COMMENT '은행 계좌 번호',
    `status`               CHAR(7)         NOT NULL    COMMENT '출금 상태(출금완료:success, 대기중:awail, 실패:fail, 취소:cancel)',
    `requested_at`         TIMESTAMP       NOT NULL    DEFAULT current_timestamp COMMENT '출금 신청 날짜',
    `updated`              TIMESTAMP       NOT NULL    DEFAULT current_timestamp COMMENT '상태 업데이트 날짜',
     PRIMARY KEY (no)
);

ALTER TABLE tr_withdrawal_log COMMENT '마일리지 출금 로그';

CREATE INDEX IX_tr_withdrawal_log_1
    ON tr_withdrawal_log(user_no, status);

ALTER TABLE tr_withdrawal_log
    ADD CONSTRAINT FK_tr_withdrawal_log_user_no_tr_account_no FOREIGN KEY (user_no)
        REFERENCES tr_account (no) ON DELETE RESTRICT ON UPDATE RESTRICT;


-- tr_payment_log Table Create SQL
CREATE TABLE tr_payment_log
(
    `no`                   BIGINT          NOT NULL    AUTO_INCREMENT COMMENT 'AI Index',
    `user_no`              BIGINT          NOT NULL    COMMENT '유저 PK',
    `method`               VARCHAR(10)     NOT NULL    COMMENT '결제 수단(credit:카드, phone:휴대전화, voucher:상품권)',
    `payment_mileage`      INT UNSIGNED    NOT NULL    COMMENT '충전 마일리지',
    `payment_information`  TEXT            NOT NULL    COMMENT '결제 상세 내역',
    `status`               CHAR(7)         NOT NULL    COMMENT '결제 상태(성공:success, 실패:fail)',
    `cancels`              TEXT            NOT NULL    COMMENT '결제 실패 내역',
    `requested_at`         TIMESTAMP       NOT NULL    DEFAULT current_timestamp COMMENT '결제 신청 일자',
     PRIMARY KEY (no)
);

ALTER TABLE tr_payment_log COMMENT '마일리지 충전 로그';

CREATE INDEX IX_tr_payment_log_1
    ON tr_payment_log(user_no, status);

ALTER TABLE tr_payment_log
    ADD CONSTRAINT FK_tr_payment_log_user_no_tr_account_no FOREIGN KEY (user_no)
        REFERENCES tr_account (no) ON DELETE RESTRICT ON UPDATE RESTRICT;


-- tr_mileage_log Table Create SQL
CREATE TABLE tr_mileage_log
(
    `no`                 BIGINT          NOT NULL    AUTO_INCREMENT COMMENT 'AI Index',
    `user_no`            BIGINT          NOT NULL    COMMENT '유저 PK',
    `method`             VARCHAR(10)     NOT NULL    COMMENT '행동(withdrawal:출금, payment:충전, trad:거래, join:가입)',
    `method_no`          BIGINT          NULL        COMMENT '관련 테이블 PK',
    `before_mileage`     INT UNSIGNED    NOT NULL    DEFAULT 0 COMMENT '이전 마일리지',
    `use_mileage`        INT UNSIGNED    NOT NULL    DEFAULT 0 COMMENT '변동 마일리지',
    `after_mileage`      INT UNSIGNED    NOT NULL    DEFAULT 0 COMMENT '변동 후 마일리지',
    `registration_date`  TIMESTAMP       NOT NULL    DEFAULT current_timestamp COMMENT '변동 일자',
     PRIMARY KEY (no)
);

ALTER TABLE tr_mileage_log COMMENT '마일리지 변동 로그';

CREATE INDEX IX_tr_mileage_log_1
    ON tr_mileage_log(user_no, method);

ALTER TABLE tr_mileage_log
    ADD CONSTRAINT FK_tr_mileage_log_user_no_tr_account_no FOREIGN KEY (user_no)
        REFERENCES tr_account (no) ON DELETE RESTRICT ON UPDATE RESTRICT;


-- tr_account_admin Table Create SQL
CREATE TABLE tr_account_admin
(
    `no`          BIGINT          NOT NULL    AUTO_INCREMENT COMMENT 'AI Index',
    `id`          VARCHAR(20)     NOT NULL    COMMENT '아이디',
    `password`    VARCHAR(255)    NOT NULL    COMMENT '패스워드',
    `name`        VARCHAR(10)     NOT NULL    COMMENT '관리자명',
    `authority`   CHAR(1)         NOT NULL    DEFAULT '0' COMMENT '권한(0:최고)',
    `status`      CHAR(5)         NOT NULL    DEFAULT 'ALIVE' COMMENT '계정 상태',
    `registered`  TIMESTAMP       NOT NULL    DEFAULT current_timestamp COMMENT '등록 일자',
    `updated`     TIMESTAMP       NOT NULL    DEFAULT current_timestamp COMMENT '업데이트 일자',
     PRIMARY KEY (no)
);

ALTER TABLE tr_account_admin COMMENT '관리자 테이블';


-- tr_trade_log Table Create SQL
CREATE TABLE tr_trade_log
(
    `no`                   BIGINT          NOT NULL    AUTO_INCREMENT COMMENT 'AI Index',
    `trade_board_no`       BIGINT          NOT NULL    COMMENT '거래 글 PK',
    `trade_product_no`     BIGINT          NOT NULL    COMMENT '상품 PK',
    `seller_no`            BIGINT          NOT NULL    COMMENT '판매자 PK',
    `seller_trade_status`  CHAR(7)         NOT NULL    DEFAULT 'ongoing' COMMENT '판매자 거래 상태(success:거래 완료, ongoing:거래중)',
    `buyer_no`             BIGINT          NOT NULL    COMMENT '구매자 PK',
    `buyer_trade_status`   CHAR(7)         NOT NULL    DEFAULT 'ongoing' COMMENT '구매자 거래 상태(success:거래 완료, ongoing:거래중)',
    `trade_price`          INT UNSIGNED    NOT NULL    COMMENT '거래 가격',
    `status`               CHAR(7)         NOT NULL    COMMENT '거래 상태(success:완료, cancel:취소, ongoing:진행중)',
    `seller_status_date`   TIMESTAMP       NULL        COMMENT '판매자 거래 상태 변경 일자',
    `buyer_status_date`    TIMESTAMP       NULL        COMMENT '구매자 거래 상태 변경 일자',
    `trade_success_date`   TIMESTAMP       NULL        COMMENT '거래 성공 일자',
    `trade_cancel_date`    TIMESTAMP       NULL        COMMENT '거래 취소 일자',
    `requested_at`         TIMESTAMP       NOT NULL    DEFAULT current_timestamp COMMENT '요청 일자',
    `updated`              TIMESTAMP       NOT NULL    DEFAULT current_timestamp COMMENT '업데이트 일자',
     PRIMARY KEY (no)
);

ALTER TABLE tr_trade_log COMMENT '거래 로그 테이블';

CREATE INDEX IX_tr_trad_log_2
    ON tr_trade_log(seller_no, buyer_no);

CREATE INDEX IX_tr_trad_log_1
    ON tr_trade_log(trade_board_no);

ALTER TABLE tr_trade_log
    ADD CONSTRAINT FK_tr_trade_log_trade_board_no_tr_board_no FOREIGN KEY (trade_board_no)
        REFERENCES tr_board (no) ON DELETE RESTRICT ON UPDATE RESTRICT;

ALTER TABLE tr_trade_log
    ADD CONSTRAINT FK_tr_trade_log_trade_product_no_tr_product_no FOREIGN KEY (trade_product_no)
        REFERENCES tr_product (no) ON DELETE RESTRICT ON UPDATE RESTRICT;

ALTER TABLE tr_trade_log
    ADD CONSTRAINT FK_tr_trade_log_seller_no_tr_account_no FOREIGN KEY (seller_no)
        REFERENCES tr_account (no) ON DELETE RESTRICT ON UPDATE RESTRICT;

ALTER TABLE tr_trade_log
    ADD CONSTRAINT FK_tr_trade_log_buyer_no_tr_account_no FOREIGN KEY (buyer_no)
        REFERENCES tr_account (no) ON DELETE RESTRICT ON UPDATE RESTRICT;


